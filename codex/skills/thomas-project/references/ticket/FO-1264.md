# CN 상점 구매제한수량 GraphQL API 개발 지시서

## 📋 **프로젝트 개요**
CN 상점(중국 상점)의 구매제한수량 검증 기능을 GraphQL API로 개발하는 프로젝트입니다.

## 🎯 **비즈니스 요구사항**

### **구매제한수량 2가지 타입**

**1. 상점 자체 구매제한수량**
- **정의**: 상점 전체에 적용되는 기본 구매제한 (현재 10개 고정)
- **적용 범위**: 모든 상품 (카테고리 무관)
- **제한 방식**: 한 주문의 전체 상품 수량 합계 제한

**2. 그룹별 구매제한수량**  
- **정의**: 관리자가 특정 상품들을 그룹으로 묶어 설정하는 제한
- **적용 조건**: 주문한 모든 상품이 동일한 그룹에 속할 때만 활성화
- **제한 방식**: 그룹 내 상품들의 수량 합계 제한

### **우선순위 규칙**
- 그룹별 제한 조건 만족 시 → **그룹별 제한 적용** (상점 자체 제한 무시)
- 그룹별 제한 조건 불만족 시 → **상점 자체 제한 적용**
- **중요**: 더 작은/큰 값 선택이 아닌 **완전 대체** 방식

## 🗃️ **데이터베이스 테이블**

### **ORDER_QTY_LIMIT (그룹별 제한 마스터)**
```sql
CREATE TABLE ORDER_QTY_LIMIT (
    QL_NO BIGINT PRIMARY KEY,           -- 그룹 고유번호
    DELIVERY_KIND_CD VARCHAR(20),       -- 배송방식 코드
    QL_NM VARCHAR(100),                 -- 그룹명
    LIMIT_QTY INT,                      -- 제한수량
    CMMT TEXT,                          -- 설명
    DEL_YN CHAR(1) DEFAULT 'N',         -- 삭제여부
    REG_USER_NO BIGINT,                 -- 등록자
    REG_DT DATETIME,                    -- 등록일시
    MOD_USER_NO BIGINT,                 -- 수정자
    MOD_DT DATETIME                     -- 수정일시
);
```

### **ORDER_QTY_LIMIT_GOODS (그룹별 상품 매핑)**
```sql
CREATE TABLE ORDER_QTY_LIMIT_GOODS (
    QL_NO BIGINT,                       -- 그룹번호 (FK)
    GOODS_NO BIGINT,                    -- 상품번호
    DEL_YN CHAR(1) DEFAULT 'N',         -- 삭제여부
    REG_USER_NO BIGINT,                 -- 등록자
    REG_DT DATETIME,                    -- 등록일시
    MOD_USER_NO BIGINT,                 -- 수정자
    MOD_DT DATETIME,                    -- 수정일시
    PRIMARY KEY (QL_NO, GOODS_NO)
);
```

## 🔍 **핵심 비즈니스 로직**

```java
// 의사코드
public PurchaseLimitByShopResponse checkPurchaseLimitByShop(List<Long> goodsNoList, int totalQuantity) {
    // 1. 기본값: 상점 자체 제한 (10개)
    int limitQuantity = 10;
    LimitType limitType = SHOP_DEFAULT;
    
    // 2. 그룹별 제한 데이터 조회
    List<GroupLimitInfo> groupLimits = queryGroupLimits(goodsNoList);
    
    // 3. 그룹별 제한 조건 검증
    Set<Long> groupNos = extractGroupNos(groupLimits);
    
    if (groupNos.size() == 1 && groupLimits.size() == goodsNoList.size()) {
        // 조건 만족: 모든 상품이 동일 그룹에 속함
        limitQuantity = groupLimits.get(0).getLimitQty();
        limitType = GROUP_LIMIT;
    }
    
    // 4. 제한 검증
    boolean isPass = (totalQuantity <= limitQuantity);
    
    return PurchaseLimitByShopResponse.builder()
        .isPass(isPass)
        .limitQuantity(limitQuantity)
        .limitType(limitType)
        .message(isPass ? null : "구매 제한 수량을 초과했습니다")
        .build();
}
```

## 📊 **조회 쿼리**

```sql
-- 그룹별 제한 정보 조회
SELECT oql.QL_NO, oql.QL_NM, oql.LIMIT_QTY, oqlg.GOODS_NO
FROM ORDER_QTY_LIMIT oql
JOIN ORDER_QTY_LIMIT_GOODS oqlg ON oql.QL_NO = oqlg.QL_NO
WHERE oql.DEL_YN = 'N' 
  AND oqlg.DEL_YN = 'N'
  AND oqlg.GOODS_NO IN (#{goodsNoList})
  AND oql.DELIVERY_KIND_CD = #{deliveryKind}
```

## 🛠️ **GraphQL API 스펙**

### **Schema 정의**
```graphql
type Query {
    """
    상점별 구매제한수량 검증
    """
    checkPurchaseLimitByShop(input: PurchaseLimitByShopRequest!): PurchaseLimitByShopResponse!
}


input PurchaseLimitByShopInput {
    cartId: ID!
}

```

## 📝 **구현 요구사항**

### **1. GraphQL Resolver 개발**
- `@Component` 또는 `@Controller` 클래스 생성
- `checkPurchaseLimitByShop` 쿼리 메서드 구현
- 입력 검증 및 예외 처리

### **2. 비즈니스 서비스 개발**
- 그룹별 제한 조회 로직
- 제한 조건 검증 로직  
- 응답 데이터 구성 로직

### **3. 데이터 액세스 레이어**
- MyBatis Mapper 또는 JPA Repository
- 그룹별 제한 조회 쿼리 구현

### **4. DTO/모델 클래스**
- GraphQL 입출력 타입에 맞는 Java 클래스들
- Builder 패턴 적용 권장

## 🧪 **테스트 케이스**

### **케이스 1: 상점 자체 제한 적용**
```
입력: goodsNoList=[1,2,3], totalQuantity=8
조건: 상품들이 서로 다른 그룹이거나 그룹 미설정
예상: isPass=true, limitQuantity=10, limitType=SHOP_DEFAULT
```

### **케이스 2: 그룹별 제한 적용**
```
입력: goodsNoList=[1,2], totalQuantity=3
조건: 모든 상품이 그룹1(제한 5개)에 속함
예상: isPass=true, limitQuantity=5, limitType=GROUP_LIMIT
```

### **케이스 3: 제한 초과**
```
입력: goodsNoList=[1,2], totalQuantity=12
조건: 상점 자체 제한(10개) 적용
예상: isPass=false, limitQuantity=10, message="구매 제한 수량을 초과했습니다"
```

### **케이스 4: 서로 다른 그룹 혼합**
```
입력: goodsNoList=[1,2,3], totalQuantity=8
조건: 상품1(그룹1), 상품2(그룹1), 상품3(그룹2)
예상: isPass=true, limitQuantity=10, limitType=SHOP_DEFAULT
```

## ⚠️ **개발 주의사항**

1. **CN 상점 전용**: shopNo=197일 때만 동작하는 기능
2. **완전 대체 로직**: 그룹별 제한이 조건 만족시 상점 제한을 완전히 무시
3. **동일 그룹 조건**: 주문한 모든 상품이 동일한 그룹에 속해야 그룹별 제한 활성화
4. **배송방식 연동**: DELIVERY_KIND_CD='bros' 조건 확인
5. **소프트 삭제**: DEL_YN='N'인 데이터만 조회
