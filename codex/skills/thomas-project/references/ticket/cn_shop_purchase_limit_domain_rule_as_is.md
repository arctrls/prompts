# CN 상점 구매제한수량 도메인 룰

---

# 🎯 도메인 룰 (Domain Rules)

### **Rule 1: 기본 적용 조건**
- **조건**: CN 상점(197번) 접속
- **적용**: 상점 제한 수량, 상품 그룹 제한 수량 로직 활성화

### **Rule 2: 배송 방법별 제한 조건**
- **상점 제한 수량**: 배송지가 중국이면서 배송방법법이 bros(yto)의 경우, 적용됩니다.
- **상품 그룹 제한 수량**: 그룹 등록시 설정된 배송 방법(`DELIVERY_KIND_CD`)과 현재 선택한 배송 방법이 일치할 때만 적용

### **Rule 3: 구매 수량 계산 기준 (알맹이 상품 계산)**
```
계산 공식: totGoodsCnt = QTY × GOODS_PACK_CNT
카운트 대상: TUBE_YN != 'Y' AND GIFTS_KIND_CD == null
```

**GOODS_PACK_CNT의 의미:**
- 패키지 안의 실제 상품 개수 (DB에 입력된 값)
- null인 경우 1로 처리 (개별 상품)

### **Rule 4: 상품 그룹 제한 수량 활성화 조건**
```
조건 1: 주문한 모든 상품이 동일한 그룹(QL_NO)에 속할 때
조건 2: 해당 그룹의 배송 방법(DELIVERY_KIND_CD)과 선택한 배송 방법이 일치할 때
결과: 상품 그룹 제한 수량 적용 (상점 제한 수량 무시)

⚠️ 중요: 동일한 상품 그룹만 구매할 때만 상점 제한 수량(10개)이 무시됩니다.
```

### **Rule 5: 상점 제한 수량 적용 조건**
```
조건: 서로 다른 그룹 상품 혼합 OR 그룹 미설정 상품 포함 OR 그룹의 배송 방법 불일치
결과: 상점 제한 수량(10개) 적용 (상품 그룹 제한 수량 무시)
```

### **Rule 6: 상품 그룹 제한 수량 적용 방식**
```
계산: 그룹 내 모든 상품 수량의 총합 vs 상품 그룹 제한 수량
방식: 합계 비교 (개별 상품별 비교 아님)
```

### **Rule 7: 상점 제한 수량 적용 방식**
```
계산: 전체 주문 수량 vs 상점 제한 수량(10개)
적용: 그룹 무관하게 전체 합계로 판단
```

### **Rule 8: 완전 대체 원칙**
```
원칙: 상품 그룹 제한 수량 조건 만족시 상점 제한 수량을 완전히 무시
방식: 더 작은 값 선택이 아닌 덮어쓰기
```

### **Rule 9: 혼합 구매의 역설적 효과**
```
완화 효과: 작은 제한의 그룹들 혼합시 상점 제한(10개)으로 인해 더 많이 구매 가능
강화 효과: 큰 제한의 그룹들 혼합시 상점 제한(10개)으로 인해 구매량 감소
```

### **Rule 10: 설계 의도**
```
이 로직은 다음과 같은 구매 패턴을 유도합니다:
1. 단일 그룹 집중 구매 장려 (프로모션 효과 극대화)
2. 다양한 상품 혼합 구매 제한 (재고 관리 단순화)  
3. 여러 번 나눠 주문 유도 (주문 빈도 증가)
```

---

## 🎯 **시나리오**

### **시나리오 A: 그룹 제한 적용 (대량 구매 성공)**
```
주문: A1(그룹1) 7개 + A2(그룹1) 8개 = 15개
그룹1 제한 수량: 20개 (BROS 배송으로 등록)
선택한 배송: BROS
상점 제한 수량: 10개

적용: 상품 그룹 제한 수량(20개) ← Rule 4
결과: ✅ 15개 ≤ 20개 구매 가능
```

### **시나리오 B: 상점 제한 적용 (혼합 구매 실패)**
```
주문: A1(그룹1) 7개 + B1(그룹2) 8개 = 15개
그룹1 제한 수량: 20개, 그룹2 제한 수량: 25개
상점 제한 수량: 10개

적용: 상점 제한 수량(10개) ← Rule 5
결과: ❌ 15개 > 10개 구매 불가
```

### **시나리오 C: 혼합 구매의 완화 효과**
```
주문: A1(그룹A) 2개 + B1(그룹B) 3개 = 5개
그룹A 제한 수량: 2개, 그룹B 제한 수량: 3개
상점 제한 수량: 10개

개별 구매: A(2개) + B(3개) = 최대 5개
혼합 구매: 상점 제한(10개) 적용 ← Rule 5
결과: ✅ 5개 ≤ 10개 구매 가능 (완화 효과)
```

### **시나리오 D: 혼합 구매의 강화 효과**
```
주문: A1(그룹A) 10개 + B1(그룹B) 5개 = 15개
그룹A 제한 수량: 15개, 그룹B 제한 수량: 20개
상점 제한 수량: 10개

개별 구매: A(15개) + B(20개) = 최대 35개
혼합 구매: 상점 제한(10개) 적용 ← Rule 5  
결과: ❌ 15개 > 10개 구매 불가 (강화 효과)
```

## 🔍 **수량 계산 예시**

| 주문 상품 | QTY | GOODS_PACK_CNT | 계산 | 실제 상품 개수 | 비고 |
|----------|-----|----------------|------|----------------|------|
| 앨범 3종 세트 1개 | 1 | 3 | 1×3=3 | ✅ **3개** | 세트 상품 |
| 개별 앨범 2개 | 2 | 1 | 2×1=2 | ✅ **2개** | 개별 상품 |
| 지관통 1개 | 1 | 1 | 제외 | ❌ **0개** | TUBE_YN='Y' |
| 특전 포토카드 2개 | 2 | 1 | 제외 | ❌ **0개** | GIFTS_KIND_CD='photocard' |

